<!doctype html>
<html lang="es" data-theme="kids">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Club Secreto: Guardianes de la Fortaleza</title>
  <style>
    :root{
      --bg:#0c1533; --panel:#0e215a; --accent:#00d4ff; --accent-2:#ffc400;
      --ok:#00d08a; --warn:#ff6b6b; --friend:#6ee7a4; --bot:#c1c7d0;
      --text:#ffffff; --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 18px;
      --focus: 3px solid #fff; --btn: linear-gradient(180deg, #00e1ff, #0099ff);
      --btn-warn: linear-gradient(180deg, #ff9aa2, #ff4d4d); --hi:#ffc400;
    }
    html,body{height:100%;}
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: radial-gradient(1200px 800px at 20% 20%, #1b2a6b 0%, var(--bg) 60%); color:var(--text); }
    
    /* Clase para congelar animaciones en pausa */
    body.is-paused *, body.is-paused *::before, body.is-paused *::after {
      animation-play-state: paused !important;
      transition: none !important;
    }

    .wrap{ max-width: 1200px; margin: 0 auto; padding: 16px 16px 32px; display:grid; gap:16px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; position: relative; z-index: 30; }
    h1{font-size:clamp(24px, 4vw, 40px); margin:.2rem 0; letter-spacing:.5px}
    .tagline{opacity:.9; font-size:clamp(14px,2.4vw,16px)}
    .game{ display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; align-items:stretch; }
    @media (max-width: 960px){ .game{grid-template-columns: 1fr;} }
    .board{ position: relative; background: linear-gradient(180deg,#0d2155,#0a1a44); border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden; min-height: 440px; }
    .ground{ position:absolute; left:0; right:0; bottom:0; height:90px; background: linear-gradient(180deg,#254,#172); }
    .club{ position:absolute; left:24px; bottom:90px; width: 280px; height: 220px; background: linear-gradient(180deg, #173e8c, #0d2b67); border:4px solid #7fb3ff; border-radius: 16px; box-shadow: inset 0 0 0 4px rgba(0,0,0,.2); transition: all .4s ease; }
    .club.public { background: rgba(127, 179, 255, 0.15); border-color: rgba(255, 107, 107, 0.7); backdrop-filter: blur(2px); }
    .club .door{ position:absolute; bottom:0; left:18px; width: 95px; height: 130px; background: #5b3719; border:4px solid #3a210f; border-bottom:none; border-radius: 12px 12px 0 0; overflow:hidden; transition: all 0.1s; }
    .club .sign{ position:absolute; top:8px; left:50%; transform:translateX(-50%); padding:6px 10px; border-radius: 12px; background: var(--accent-2); color:#2b1600; font-weight:800; box-shadow: 0 2px 0 rgba(0,0,0,.2); }
    .club .shield{ position:absolute; inset:-6px; border-radius: 16px; pointer-events:none; }
    .force{ box-shadow: 0 0 0 6px rgba(0,212,255,.5), 0 0 30px 12px rgba(0,212,255,.35) inset; border-radius:16px; animation: pulse 1.2s ease-in-out infinite; }
    .entity{ position:absolute; bottom:100px; right:-100px; width:64px; height:64px; border-radius: 16px; display:grid; place-items:center; font-size:32px; font-weight:800; color:#111; outline:none; transform: scale(0.5); opacity: 0; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.2s ease-out; cursor: pointer; }
    .entity.spawned { transform: scale(1); opacity: 1; }
    .friend{ background: var(--friend); border:4px solid #228b5a; }
    .bot{ background: var(--bot); border:4px solid #70757a; }
    .phish{ background: #ffd6a5; border:4px solid #b66a00; width: 80px; height: 80px; font-size: 42px; animation: phish-wobble 2s ease-in-out infinite; }
    .phish.phasing { animation: phish-wobble 2s ease-in-out infinite, phasing 0.5s linear infinite; }
    .spam, .potential_friend{ width: 50px; height:36px; border-radius: 6px; font-size:22px; }
    .spam{ background:#c5ffd6; border:4px solid #1aa36b; }
    .potential_friend { background: #ffefb8; border:4px solid #d4a200; }
    .data_packet { background: linear-gradient(45deg, #a29bfe, #74b9ff); border: 4px solid #6c5ce7; font-size: 30px; }
    .glitch_bot { background: linear-gradient(45deg, #ff7675, #fab1a0); border: 4px solid #d63031; font-size: 30px; animation: glitch-jump 0.5s infinite; }
    
    .panel{ background: linear-gradient(180deg, #132b69, #0c245b); border-radius: var(--radius); box-shadow: var(--shadow); padding:16px; display:grid; gap:12px; }
    .panel h2{ margin:.2rem 0 .4rem; font-size: clamp(18px,2.6vw,22px) }
    .switch{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; background:#0c1e4f; border:2px solid #1c3b8c; border-radius: 14px; transition: all 0.3s ease; }
    .switch.glitched { background: #5a0e0e; border-color: #ff4d4d; pointer-events: none; opacity: 0.6; animation: glitch-static 0.1s linear infinite; }
    .toggle{ position:relative; width: 170px; height: 44px; border-radius: 999px; background:#203d8e; border:2px solid #3a6be0; cursor:pointer; }
    .thumb{ position:absolute; top:3px; left:3px; width: 80px; height: 34px; border-radius: 999px; background: var(--accent); transition: transform .2s ease; display:grid; place-items:center; color:#00203a; font-weight:900; }
    .toggle[data-state="right"] .thumb{ transform: translateX(82px); }
    .hi{ position:relative; border-radius:14px; box-shadow: 0 0 0 4px var(--hi), 0 0 24px 12px rgba(255,196,0,.55); animation: hiPulse 1.1s ease-in-out infinite; }
    
    .btn{ padding:12px 16px; border:none; border-radius: 16px; background: var(--btn); color:#00203a; font-weight:900; cursor:pointer; box-shadow: var(--shadow); font-size:16px; }
    .btn.secondary{ background: linear-gradient(180deg, #e0edff, #9ec8ff); }
    .btn.warn{ background: var(--btn-warn); color:#2d0000; }
    .status{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; background: #0b1b49; border:2px solid #254aa8; border-radius: var(--radius); padding:10px 12px; }
    .pill{ background:#072047; padding:8px 12px; border-radius: 999px; border:1px solid #1e57c3; font-weight:800 }
    
    #mentor-message { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.4); border: 2px solid var(--accent); padding: 8px 16px; border-radius: 999px; font-weight: 700; text-align: center; max-width: 90%; animation: fadeInDown 0.5s ease-out; }
    #legend-panel { position: absolute; bottom: 100px; right: 10px; background: rgba(14, 33, 90, 0.8); backdrop-filter: blur(4px); border: 2px solid #3a6be0; border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); font-size: 13px; }
    #legend-panel h4 { margin: 0 0 8px 0; font-size: 15px; }
    #legend-panel ul { list-style: none; margin: 0; padding: 0; display: grid; gap: 6px; }
    #legend-panel li { display: flex; align-items: center; gap: 8px; }
    #legend-panel li span { font-size: 22px; line-height: 1; }
    
    #antivirus-btn { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 16px 24px; font-size: 20px; border-radius: 20px; background: linear-gradient(180deg, #00d08a, #008a5c); color: #fff; text-shadow: 0 1px 2px #000; animation: hiPulse 1.1s ease-in-out infinite; }
    .board.flash { animation: antivirus-flash 0.4s ease-out; }

    /* Overlay general styles */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: grid; place-items: center; z-index: 100; backdrop-filter: blur(5px); }
    .modal { background: #132b69; padding: 32px; border-radius: 24px; border: 4px solid var(--accent); text-align: center; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .modal h3 { margin-top: 0; font-size: 28px; color: var(--accent-2); }
    .row { display: flex; justify-content: center; gap: 12px; margin-top: 24px; }

    @keyframes pulse{ 50%{ box-shadow: 0 0 0 6px rgba(0,212,255,.65), 0 0 50px 16px rgba(0,212,255,.55) inset; } }
    @keyframes hiPulse{ 50%{ box-shadow: 0 0 0 4px #ffe17a, 0 0 30px 14px rgba(255,225,122,.85);} }
    @keyframes fadeInDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    @keyframes phish-wobble { 0%, 100% { transform: scale(1) translateY(0) rotate(-2deg); } 50% { transform: scale(1.05) translateY(-8px) rotate(2deg); } }
    @keyframes phasing { 0% { opacity: 0.8; } 50% { opacity: 0.5; } 100% { opacity: 0.8; }}
    @keyframes glitch-jump { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(2px, -2px); } 50% { transform: translate(-2px, 2px); } 75% { transform: translate(2px, 2px); } }
    @keyframes glitch-static { 0%, 100% { transform: translate(0,0); } 33% { transform: translate(-1px, 1px); } 66% { transform: translate(1px, -1px); } }
    @keyframes antivirus-flash { from { box-shadow: inset 0 0 0 0 var(--ok); } to { box-shadow: inset 0 0 100px 50px var(--ok); } }
  </style>
</head>
<body>
  <div class="wrap" role="application">
    <header>
      <div><h1 id="title">El Club Secreto: Guardianes de la Fortaleza</h1><p class="tagline">Protege tu espacio digital usando escudos de privacidad.</p></div>
      <div class="row">
        <button class="btn secondary" id="btn-help">Ayuda</button>
        <button class="btn secondary" id="btn-tutorial-restart">Ver Tutorial</button>
        <button class="btn secondary" id="btn-pause" style="display:none;" aria-label="Pausar juego">‚è∏ Pausa</button>
        <button class="btn" id="btn-start">Comenzar Defensa</button>
      </div>
    </header>
    <div class="status" aria-live="polite"><div class="pill" id="wave-pill">Oleada: 0/4</div><div class="pill" id="score-pill">Felicidad: 100</div><div class="pill" id="key-pill">Llaves doradas: 0</div><div class="pill" id="goal-pill" hidden></div></div>
    <div class="game">
      <section class="board" id="board">
        <div class="club" id="club-visual"><div class="sign">CLUB SECRETO</div><div class="door"></div><div class="shield" id="shield-visual"></div></div>
        <div class="ground"></div>
        <div id="announce" class="sr-only" aria-live="assertive"></div>
        <div id="mentor-message" hidden></div>
        <div id="legend-panel">
          <h4>Leyenda</h4>
          <ul>
            <li><span>üôÇ</span> Amigo</li>
            <li><span>‚ùì</span> Curi-Bot &rarr; <strong>Perfil Privado</strong></li>
            <li><span>‚úâÔ∏è</span> Spam &rarr; <strong>Mensajes "Solo Amigos"</strong></li>
            <li><span>ü•∏</span> Bot Imitador &rarr; <strong>Lista "Solo Yo"</strong></li>
          </ul>
        </div>
        <button id="antivirus-btn" class="btn" hidden>‚ö° Antivirus Scan ‚ö°</button>
      </section>
      <aside class="panel" id="control-panel"><h2>Panel de Control</h2><p id="panel-desc">Usa los escudos para defenderte.</p><div class="switch" role="group"><label id="lbl-profile">Perfil</label><div class="toggle" id="tgl-profile" tabindex="0" role="switch" aria-checked="false" data-state="left" data-left="P√∫blico" data-right="Privado"><div class="thumb">P√∫blico</div></div></div><div class="switch" role="group"><label id="lbl-msg">Mensajes</label><div class="toggle" id="tgl-msg" tabindex="0" role="switch" aria-checked="false" data-state="left" data-left="Todos" data-right="Solo amigos"><div class="thumb">Todos</div></div></div><div class="switch" role="group"><label id="lbl-friends">Lista Amigos</label><div class="toggle" id="tgl-friends" tabindex="0" role="switch" aria-checked="false" data-state="left" data-left="Todos" data-right="Solo yo"><div class="thumb">Todos</div></div></div><div class="row"><button class="btn warn" id="btn-report" disabled>Reportar y Bloquear üö´</button></div></aside>
    </div>
    <footer><span aria-hidden="true">üõ°Ô∏è</span> Ciudadan√≠a Digital ‚Äî Privacidad y Seguridad Digital. <span aria-hidden="true">üß†</span></footer>
  </div>
  
  <!-- Pantalla de Resultado -->
  <div class="overlay" id="result" hidden role="dialog" aria-modal="true" style="display:none"><div class="modal"><h3 id="result-title">Fin</h3><p id="result-desc"></p><div class="row"><button class="btn" id="btn-retry">Jugar de nuevo</button></div></div></div>
  
  <!-- Pantalla de Pausa -->
  <div class="overlay" id="pause-overlay" hidden style="display:none"><div class="modal"><h3>Juego Pausado</h3><p>T√≥mate un respiro, Guardi√°n.</p><div class="row"><button class="btn secondary" id="btn-restart-pause">Reiniciar</button><button class="btn" id="btn-resume">Continuar ‚ñ∂</button></div></div></div>

  <!-- Pantalla de Tutorial -->
  <div class="overlay tutorial" id="tutorial"><div class="modal" style="width: min(480px, 92vw); pointer-events: auto;"><h3 id="tut-title">¬°Bienvenido al Tutorial!</h3><p id="tut-desc">Aprende a usar cada escudo para proteger tu club.</p><div id="tut-body" style="min-height:120px; margin-top:6px; padding: 10px; background: #0c1e4f; border-radius: var(--radius);"></div><div class="progress"><div id="tut-bar" class="bar" style="width:0%"></div></div><div class="steps" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;"><button class="btn secondary" id="tut-skip">Omitir Tutorial y Jugar</button><div style="display: flex; align-items: center; gap: 10px;"><button class="btn secondary" id="tut-prev" disabled>‚Üê</button><div id="tut-step-label" aria-live="polite">Paso 1/8</div><button class="btn" id="tut-next">‚Üí</button></div></div></div></div>

  <script>
  const VOZ_ON = true;
  
  // MEJORA 1: Funci√≥n speak robusta para evitar trabas
  function speak(text){ 
    if(!VOZ_ON || !('speechSynthesis' in window)) return; 
    // Cancelar cualquier audio pendiente para evitar que se amontonen
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text); 
    u.lang = 'es-MX'; u.rate = 1.05; u.pitch = 1.0; u.volume = 1.0; 
    window.speechSynthesis.speak(u); 
  }
  
  const audioCtx = typeof AudioContext !== 'undefined' ? new AudioContext() : null;
  function beep(type='ok', volume=0.06){ if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = type==='error' ? 'square' : 'sine'; o.frequency.value = type==='error'? 140 : 540; g.gain.value = volume; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(), 160); }

  const state = { running:false, paused: false, waveIndex:0, score:100, keys:0, profilePrivate:false, messagesFriendsOnly:false, friendsListOnlyMe:false, phishReportedCount: 0, toggles:[], spawnTimer:null, entities: [], hintsShown: new Set(), antivirusReady: false, disabledSwitchId: null };

  const ENTITY_SPECS = {
    friend: { emoji: 'üôÇ', speed: 1.1 }, bot: { emoji: '‚ùì', speed: 1.0, hint: 'tgl-profile' },
    spam: { emoji: '‚úâÔ∏è', speed: 1.6, hint: 'tgl-msg' }, potential_friend: { emoji: 'üíå', speed: 1.4, hint: 'tgl-msg' },
    disguised_bot: { emoji: 'ü•∏', speed: 1.3, hint: 'tgl-friends', behavior: 'drain' },
    phish: { emoji: 'ü§ñ', speed: 0.8, behavior: 'immune' },
    glitch_bot: { emoji: 'üëæ', behavior: 'glitch' }, data_packet: { emoji: 'üì¶', speed: 1.5 }
  };

  const OLEADAS = [
    { id:1, nombre:'Escudo Principal', pool: ['friend', 'bot', 'glitch_bot', 'data_packet'] },
    { id:2, nombre:'Escudo de Mensajes', pool: ['friend', 'spam', 'potential_friend', 'glitch_bot'] },
    { id:3, nombre:'Escudo de Lista', pool: ['friend', 'disguised_bot', 'glitch_bot', 'data_packet'] },
    { id:4, nombre:'¬°Defensa Final!', infinite: true, goal: 3, pool: ['friend', 'bot', 'spam', 'phish', 'glitch_bot'] }
  ];

  const board = document.getElementById('board');
  const club = document.getElementById('club-visual');
  const shieldVisual = document.getElementById('shield-visual');
  const wavePill = document.getElementById('wave-pill');
  const scorePill = document.getElementById('score-pill');
  const keyPill = document.getElementById('key-pill');
  const goalPill = document.getElementById('goal-pill');
  const btnStart = document.getElementById('btn-start');
  const btnPause = document.getElementById('btn-pause');
  const pauseOverlay = document.getElementById('pause-overlay');
  const btnTutorialRestart = document.getElementById('btn-tutorial-restart');
  const btnReport = document.getElementById('btn-report');
  const antivirusBtn = document.getElementById('antivirus-btn');
  const tProfile = document.getElementById('tgl-profile');
  const tMsg = document.getElementById('tgl-msg');
  const tFriends = document.getElementById('tgl-friends');
  const announce = document.getElementById('announce');
  const tutorial = document.getElementById('tutorial');
  const mentorMessage = document.getElementById('mentor-message');

  state.toggles = [tProfile, tMsg, tFriends];
  
  function announceMsg(text){ if (announce) announce.textContent = text || ''; }

  function toggleSwitch(el){
    // No permitir cambios si est√° en pausa o game over
    if (state.paused || !state.running && el.closest('#tutorial').hidden) return;
    
    const cur = el.getAttribute('data-state'); const next = cur === 'left' ? 'right' : 'left';
    el.setAttribute('data-state', next);
    el.querySelector('.thumb').textContent = next === 'left' ? el.getAttribute('data-left') : el.getAttribute('data-right');
    const checked = next === 'right';
    el.setAttribute('aria-checked', String(checked));
    if(el === tProfile) { state.profilePrivate = checked; club.classList.toggle('public', !checked); }
    if(el === tMsg) state.messagesFriendsOnly = checked;
    if(el === tFriends) { state.friendsListOnlyMe = checked; if (checked) defeatImpersonator(); }
    if(state.profilePrivate) shieldOn(); else shieldOff();
    beep('ok');
  }
  function shieldOn(){ shieldVisual.className = 'shield force'; }
  function shieldOff(){ shieldVisual.className = 'shield'; }

  // MEJORA 2: Funci√≥n de Toggle Pause
  function togglePause() {
    if (!state.running) return;
    state.paused = !state.paused;
    
    if (state.paused) {
      document.body.classList.add('is-paused');
      pauseOverlay.style.display = 'grid';
      pauseOverlay.hidden = false;
      window.speechSynthesis.cancel(); // Silenciar al pausar
      btnPause.style.display = 'none';
    } else {
      document.body.classList.remove('is-paused');
      pauseOverlay.style.display = 'none';
      pauseOverlay.hidden = true;
      btnPause.style.display = 'inline-block';
      spawnLoop(); // Reiniciar loop de enemigos
    }
  }

  function iniciarJuego(){
    tutorial.hidden = true; tutorial.style.display = 'none';
    state.running = true; state.paused = false; 
    document.body.classList.remove('is-paused');
    btnPause.style.display = 'inline-block'; // Mostrar bot√≥n pausa
    
    state.waveIndex = 0; state.score = 100; state.phishReportedCount = 0;
    state.antivirusReady = false; antivirusBtn.hidden = true;
    if (state.disabledSwitchId) { document.getElementById(state.disabledSwitchId).parentElement.classList.remove('glitched'); state.disabledSwitchId = null; }
    state.profilePrivate = false; state.messagesFriendsOnly = false; state.friendsListOnlyMe = false; state.hintsShown.clear();
    [tProfile, tMsg, tFriends].forEach(t=>{ if(t.getAttribute('data-state')==='right') toggleSwitch(t); });
    club.classList.add('public'); document.querySelectorAll('.graffiti').forEach(g => g.remove());
    btnReport.disabled = true; btnReport.setAttribute('aria-pressed','false');
    updateHUD(); clearEntities();
    document.getElementById('result').hidden = true; document.getElementById('result').style.display = 'none';
    speak('¬°Comienza la defensa!');
    mostrarOleada(0);
  }

  function mostrarOleada(id){
    if(!state.running || !OLEADAS[id]) return;
    const wave = OLEADAS[id]; state.waveIndex = id+1; updateHUD(); state.hintsShown.clear();
    
    mentorMessage.textContent = OLEADAS[id].mentorText || `Oleada ${state.waveIndex}`; mentorMessage.hidden = false;
    let waveMessage = `Oleada ${state.waveIndex}: ${wave.nombre}.`;
    if (wave.infinite) { goalPill.hidden = false; }
    announceMsg(waveMessage); speak(waveMessage);
    
    btnReport.disabled = !wave.infinite;
    state.spawnTimer && clearTimeout(state.spawnTimer);
    
    state.spawnCount = 0; // Usar variable en state para persistencia
    state.currentWavePool = wave.pool;
    state.isInfinite = wave.infinite;
    
    spawnLoop();
  }

  function spawnLoop() {
    if (!state.running || state.paused) return; // Detener si est√° pausado
    
    const maxSpawns = 12;
    if (!state.isInfinite && state.spawnCount >= maxSpawns) { 
        setTimeout(() => { if(!state.paused && state.running) nextWave(); }, 5000); 
        return; 
    }

    let nextSpawnDelay = 1500 + Math.random() * 2000;
    
    if (Math.random() < 0.25) { 
        const swarmSize = 2 + Math.floor(Math.random() * 2);
        for (let i=0; i < swarmSize; i++) {
            setTimeout(() => { if(!state.paused) spawnEntity(state.currentWavePool[Math.floor(Math.random() * state.currentWavePool.length)]); }, i * 400);
        }
        state.spawnCount += swarmSize;
        nextSpawnDelay += swarmSize * 400;
    } else {
        spawnEntity(state.currentWavePool[Math.floor(Math.random() * state.currentWavePool.length)]);
        state.spawnCount++;
    }
    state.spawnTimer = setTimeout(spawnLoop, nextSpawnDelay);
  }

  function highlightHint(elementId) {
    if (!elementId || state.hintsShown.has(elementId)) return;
    state.hintsShown.add(elementId);
    const el = document.getElementById(elementId).parentElement;
    if (el) { el.classList.add('hi'); setTimeout(() => el.classList.remove('hi'), 3000); }
  }

  function spawnEntity(kind){
    if (state.paused) return;
    const spec = ENTITY_SPECS[kind];
    if (spec.hint) { highlightHint(spec.hint); }
    const e = document.createElement('button');
    e.className = `entity ${kindToClass(kind)}`;
    e.setAttribute('aria-label', labelFor(kind));
    e.dataset.kind = kind; e.textContent = spec.emoji;
    board.appendChild(e); state.entities.push(e);
    requestAnimationFrame(() => { e.classList.add('spawned'); });

    if (spec.behavior === 'glitch') {
        e.style.right = `${10 + Math.random() * 70}%`;
        e.style.bottom = `${30 + Math.random() * 60}%`;
        if (!state.disabledSwitchId) {
            const availableSwitches = state.toggles.filter(t => t.id !== 'btn-report');
            const randomSwitch = availableSwitches[Math.floor(Math.random() * availableSwitches.length)];
            state.disabledSwitchId = randomSwitch.id;
            randomSwitch.parentElement.classList.add('glitched');
        }
    } else if (spec.behavior === 'drain') {
        e.style.right = '10px';
        club.classList.add('draining');
        e._drainTimer = setInterval(() => { 
            // MEJORA 3: L√≥gica Impersonator arreglada
            // Verifica pausa y usa modo silencioso para damage
            if(state.running && !state.paused) { 
                damage('¬°El Bot Imitador est√° molestando!', 2, true); // true = silencioso
            } 
        }, 1500);
        // Feedback inicial hablado solo una vez
        speak('¬°Alerta! Un Bot Imitador se ha colado. Revisa tu lista de amigos.');
    } else {
        const end = 70; let x = board.clientWidth - 80;
        const step = ()=>{
            if (!e.parentNode) return;
            // MEJORA 4: Congelar movimiento en JS
            if (state.paused) { e._anim = requestAnimationFrame(step); return; }
            
            let speedMultiplier = 1.0;
            if (spec.behavior === 'immune' && state.profilePrivate && x < 310 && x > 90) { e.classList.add('phasing'); speedMultiplier = 0.5; } else { e.classList.remove('phasing'); }
            x -= (spec.speed || 1) * 2.0 * speedMultiplier;
            e.style.right = `${board.clientWidth - x - 80}px`;
            if(x <= end){ validarAccionEntity(e); return; }
            e._anim = requestAnimationFrame(step);
        };
        e._anim = requestAnimationFrame(step);
    }
  }

  function validarAccionEntity(entity){
    if(!entity || !entity.parentNode) return;
    const kind = entity.dataset.kind;
    if (kind === 'phish') { damage('¬°El Bot de Phishing ha entrado!', 30); removeEntity(entity); return; }
    if (kind === 'data_packet') { removeEntity(entity); return; } 
    if(kind==='friend'){
      if(state.profilePrivate) { addScore(15, '¬°Amigo entr√≥ seguro!'); } 
      else { addScore(5, 'Amigo entr√≥, pero el perfil es P√∫blico.'); }
      const door = document.querySelector('.club .door'); door.classList.add('open');
      setTimeout(() => door.classList.remove('open'), 300);
      removeEntity(entity); return;
    }
    removeEntity(entity);
    if(kind==='bot'){
      if(state.profilePrivate){ feedback('ok','Curi-Bot bloqueado.'); }
      else { damage('¬°Curi‚ÄëBot entr√≥! Activa perfil privado.'); }
    }
    if(kind==='spam'){ if(state.messagesFriendsOnly){ feedback('ok','Spam bloqueado.'); } else { damage('¬°Spam recibido!'); } }
    if(kind==='potential_friend'){ if(state.messagesFriendsOnly){ feedback('error','¬°Invitaci√≥n perdida!'); } else { addScore(25, '¬°Invitaci√≥n recibida!'); } }
  }
  
  function defeatImpersonator() {
    const impersonator = state.entities.find(e => e.dataset.kind === 'disguised_bot');
    if (impersonator) {
        clearInterval(impersonator._drainTimer);
        club.classList.remove('draining');
        removeEntity(impersonator, 500);
        addScore(20, '¬°Bot Imitador confundido!');
    }
  }
  
  board.addEventListener('click', (event) => {
    if (state.paused) return;
    const target = event.target.closest('.entity');
    if (!target || !state.running) return;
    const kind = target.dataset.kind;

    if (kind === 'glitch_bot') {
        if(state.disabledSwitchId) {
            document.getElementById(state.disabledSwitchId).parentElement.classList.remove('glitched');
            state.disabledSwitchId = null;
        }
        feedback('ok', '¬°Glitch eliminado!');
        removeEntity(target);
    }
    if (kind === 'data_packet') {
        state.antivirusReady = true;
        antivirusBtn.hidden = false;
        feedback('ok', '¬°Antivirus cargado!');
        removeEntity(target);
    }
  });

  antivirusBtn.addEventListener('click', () => {
    if (!state.antivirusReady || state.paused) return;
    state.antivirusReady = false;
    antivirusBtn.hidden = true;
    board.classList.add('flash');
    setTimeout(() => board.classList.remove('flash'), 400);
    const bots = state.entities.filter(e => ['bot', 'disguised_bot', 'glitch_bot'].includes(e.dataset.kind));
    bots.forEach(bot => removeEntity(bot));
    if (bots.length > 0) feedback('ok', '¬°Amenazas eliminadas!');
  });
  
  function handlePhishReport() {
    if (!state.running || state.paused || OLEADAS[state.waveIndex - 1]?.id !== 4) return;
    const phishBot = state.entities.find(e => e.dataset.kind === 'phish');
    if (phishBot) {
        state.phishReportedCount++; updateHUD();
        feedback('boss','¬°Bot de Phishing reportado!');
        removeEntity(phishBot);
        if (state.phishReportedCount >= OLEADAS[3].goal) { setTimeout(() => finalizarJuego('victoria'), 1000); }
    } else { feedback('error', 'No hay Bot de Phishing que reportar.'); damage('¬°Reporte en falso!', 2); }
  }
  
  function addScore(n, msg=''){ state.score = Math.max(0, state.score + n); updateHUD(); if(msg) feedback('ok', msg); scorePill.classList.add('score-updated'); setTimeout(() => scorePill.classList.remove('score-updated'), 300); }
  
  // MEJORA: Parametro 'silent' para evitar spam de voz
  function damage(msg, amount = 10, silent = false){ 
    addScore(-amount); 
    feedback('error', msg, silent); 
    const graffiti = document.createElement('div'); graffiti.className = 'graffiti'; club.appendChild(graffiti); 
    setTimeout(() => graffiti.remove(), 1000); 
    if(state.score<=0 && state.running) finalizarJuego('derrota'); 
  }

  function nextWave(){ if(state.waveIndex >= OLEADAS.length -1){ mostrarOleada(3); } else { mostrarOleada(state.waveIndex); } }
  function removeEntity(entity, delay = 0) { if(!entity) return; cancelAnimationFrame(entity._anim); clearInterval(entity._drainTimer); setTimeout(() => { entity.remove(); state.entities = state.entities.filter(e => e !== entity); }, delay); }
  function clearEntities(){ [...state.entities].forEach(e => removeEntity(e)); club.classList.remove('draining');}
  
  function updateHUD(){ wavePill.textContent = `Oleada: ${Math.min(state.waveIndex,4)}/4`; scorePill.textContent = `Felicidad: ${state.score}`; keyPill.textContent = `Llaves doradas: ${state.keys}`; if (OLEADAS[state.waveIndex-1]?.infinite) { goalPill.textContent = `Reportados: ${state.phishReportedCount}/${OLEADAS[3].goal}`; } else { goalPill.hidden = true; } }
  function kindToClass(kind) { return {friend:'friend', bot:'bot', phish:'phish', spam:'spam', potential_friend: 'potential_friend', disguised_bot: 'bot', glitch_bot: 'glitch_bot', data_packet: 'data_packet'}[kind] || ''; }
  function labelFor(kind){ return {friend:'Amigo', bot:'Curi‚ÄëBot', phish:'Bot de Phishing', spam:'Spam', potential_friend:'Invitaci√≥n', disguised_bot: 'Bot Imitador', glitch_bot: 'Glitch Bot', data_packet: 'Paquete de Datos'}[kind] || 'Entidad'; }
  
  function feedback(tipo, msg, silent = false){ 
    if(tipo==='ok'){ if(!silent) speak(msg); beep('ok'); } 
    else if(tipo==='error'){ if(!silent) speak(msg); beep('error'); } 
    else if(tipo==='boss'){ speak(msg); } 
    announce.textContent = msg; 
  }

  function finalizarJuego(resultado){
    state.running = false; clearEntities(); clearTimeout(state.spawnTimer);
    btnPause.style.display = 'none'; // Ocultar pausa al final
    mentorMessage.hidden = true;
    let title='', desc='';
    if(resultado==='victoria'){ state.keys += 1; updateHUD(); title = '¬°Victoria! Fiesta segura üéâ'; desc = '¬°Misi√≥n cumplida! Tu club es una fortaleza.'; } 
    else { title = 'Fiesta cancelada üòø'; desc = 'Demasiados intrusos arruinaron la fiesta. ¬°Int√©ntalo de nuevo!'; }
    const resultDialog = document.getElementById('result');
    resultDialog.querySelector('#result-title').textContent = title; resultDialog.querySelector('#result-desc').textContent = desc;
    resultDialog.hidden = false; resultDialog.style.display = 'grid'; resultDialog.querySelector('#btn-retry').focus();
  }

  const STEPS = [ 
    { id:1, t:'Bienvenida', d:'Tu misi√≥n es proteger el Club. Usa la <strong>Leyenda</strong> para saber c√≥mo defenderte de cada amenaza.' },
    { id:2, t:'Panel de Control', d:'Aqu√≠ est√°n tus escudos. El juego te dar√° <strong>pistas visuales</strong> sobre cu√°l usar.' },
    { id:3, t:'El Escudo Principal', d:'Activa <strong>Perfil Privado</strong>. Es tu mejor defensa: los amigos üôÇ entran seguros y los Curi-Bots ‚ùì son bloqueados.'},
    { id:4, t:'El Bot Imitador', d:'El Bot Imitador ü•∏ drenar√° tu felicidad. ¬°La √∫nica forma de detenerlo es activar <strong>Lista "Solo Yo"</strong>!' },
    { id:5, t:'El Glitch Bot', d:'¬°Cuidado! El Glitch Bot üëæ desactivar√° tus escudos. ¬°Hazle <strong>clic encima</strong> para destruirlo y recuperar el control!' },
    { id:6, t:'El Antivirus', d:'Recoge los Paquetes de Datos üì¶ para cargar el <strong>Antivirus Scan</strong>. ¬°√ösalo para limpiar la pantalla de bots en una emergencia!' },
    { id:7, t:'El Bot de Phishing', d:'El Bot de Phishing ü§ñ atraviesa tus escudos. ¬°Usa el bot√≥n <strong>Reportar y Bloquear</strong> para expulsarlo!' },
    { id:8, t:'¬°A Jugar!', d:'Ya conoces todas las herramientas. ¬°Ahora protege tu club y divi√©rtete!' }
  ];
  let stepIndex = 0;
  function startTutorial(isRestart = false){ clearEntities(); [tProfile, tMsg, tFriends].forEach(t=>{ if(t.getAttribute('data-state')==='right') toggleSwitch(t); }); shieldOff(); btnReport.disabled = true; tutorial.hidden=false; tutorial.style.display='grid'; if (!isRestart) speak('Bienvenido al tutorial de Guardianes de la Fortaleza.'); showStep(0); }
  function showStep(i){ stepIndex = i; const s = STEPS[i]; clearEntities(); document.querySelectorAll('.hi').forEach(n=>n.classList.remove('hi')); document.getElementById('tut-prev').disabled = i===0; document.getElementById('tut-next').textContent = (i===STEPS.length-1)? '¬°Jugar!' : '‚Üí'; document.getElementById('tut-step-label').textContent = `Paso ${i+1}/${STEPS.length}`; document.getElementById('tut-bar').style.width = `${((i)/(STEPS.length-1))*100}%`; document.getElementById('tut-body').innerHTML = `<strong>${s.t}</strong><br>${s.d}`; const elId = {3:'tgl-profile',4:'tgl-friends',5:null,6:null,7:'btn-report'}[s.id]; if(elId) document.getElementById(elId).parentElement.classList.add('hi'); if (s.id === 3) { toggleIfNeeded(tProfile, true); spawnDemo('friend'); setTimeout(() => spawnDemo('bot'), 1500); } if (s.id === 4) { spawnDemo('disguised_bot'); setTimeout(() => { toggleIfNeeded(tFriends, true); }, 2500); } if (s.id === 5) { const glitch = spawnDemo('glitch_bot'); setTimeout(() => { if (state.disabledSwitchId) document.getElementById(state.disabledSwitchId).parentElement.classList.add('hi'); }, 500); } if (s.id === 6) { spawnDemo('data_packet'); setTimeout(() => { if (!antivirusBtn.hidden) antivirusBtn.classList.add('hi'); spawnDemo('bot'); }, 2000); } if (s.id === 7) { btnReport.disabled = false; toggleIfNeeded(tProfile, true); spawnDemo('phish'); } speak(s.t); }
  function spawnDemo(kind){ const spec = ENTITY_SPECS[kind]; const e = document.createElement('button'); e.className = `entity ${kindToClass(kind)}`; e.setAttribute('aria-label', labelFor(kind)); e.dataset.kind = kind; e.textContent = spec.emoji; board.appendChild(e); state.entities.push(e); requestAnimationFrame(() => { e.classList.add('spawned'); }); return e; }
  function toggleIfNeeded(toggleEl, makeRight){ const isRight = toggleEl.getAttribute('data-state')==='right'; if(!!isRight !== !!makeRight){ toggleSwitch(toggleEl); } }
  
  btnStart.addEventListener('click', iniciarJuego);
  btnTutorialRestart.addEventListener('click', () => startTutorial(true));
  
  // Event listeners para pausa
  btnPause.addEventListener('click', togglePause);
  document.getElementById('btn-resume').addEventListener('click', togglePause);
  document.getElementById('btn-restart-pause').addEventListener('click', () => { togglePause(); iniciarJuego(); });
  
  [tProfile, tMsg, tFriends].forEach(t=>{ t.addEventListener('click', ()=> toggleSwitch(t)); t.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); toggleSwitch(t); } }); });
  btnReport.addEventListener('click', handlePhishReport);
  document.getElementById('btn-retry').addEventListener('click', iniciarJuego);
  document.getElementById('tut-prev').addEventListener('click', ()=>{ if(stepIndex>0) showStep(stepIndex-1); });
  document.getElementById('tut-next').addEventListener('click', () => { if (stepIndex < STEPS.length - 1) { showStep(stepIndex + 1); } else { iniciarJuego(); } });
  document.getElementById('tut-skip').addEventListener('click', iniciarJuego);
  
  document.addEventListener('DOMContentLoaded', () => { tutorial.style.display = 'grid'; startTutorial(); });
  </script>
</body>
</html>
