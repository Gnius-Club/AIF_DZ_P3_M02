<!doctype html>
<html lang="es" data-theme="kids">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Club Secreto: Guardianes de la Fortaleza</title>
  <meta name="description" content="Juego educativo de ciudadanía digital sobre privacidad y gestión de información personal. Single-page app con accesibilidad y sin librerías externas." />
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --bg:#0c1533;
      --panel:#0e215a;
      --accent:#00d4ff;
      --accent-2:#ffc400;
      --ok:#00d08a;
      --warn:#ff6b6b;
      --friend:#6ee7a4;
      --bot:#c1c7d0;
      --text:#ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --focus: 3px solid #fff;
      --btn: linear-gradient(180deg, #00e1ff, #0099ff);
      --btn-warn: linear-gradient(180deg, #ff9aa2, #ff4d4d);
      --hi:#ffc400;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 20%, #1b2a6b 0%, var(--bg) 60%);
      color:var(--text);
    }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 16px 16px 32px; display:grid; gap:16px; }
    header{ 
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; 
      position: relative; 
      z-index: 30;
    }
    h1{font-size:clamp(24px, 4vw, 40px); margin:.2rem 0; letter-spacing:.5px}
    .tagline{opacity:.9; font-size:clamp(14px,2.4vw,16px)}
    .game{ display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; align-items:stretch; }
    @media (max-width: 960px){ .game{grid-template-columns: 1fr;} }

    .board{
      position: relative; background: linear-gradient(180deg,#0d2155,#0a1a44); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow:hidden; min-height: 440px;
    }
    .ground{ position:absolute; left:0; right:0; bottom:0; height:90px; background: linear-gradient(180deg,#254,#172); }
    .club{
      position:absolute; left:24px; bottom:90px; width: 280px; height: 220px;
      background: linear-gradient(180deg, #173e8c, #0d2b67);
      border:4px solid #7fb3ff; border-radius: 16px; box-shadow: inset 0 0 0 4px rgba(0,0,0,.2);
      transition: background .4s ease, border-color .4s ease, backdrop-filter .4s ease;
    }
    .club.public { background: rgba(127, 179, 255, 0.15); border-color: rgba(255, 107, 107, 0.7); backdrop-filter: blur(2px); }
    .club .door{ position:absolute; bottom:0; left:18px; width: 95px; height: 130px; background: #5b3719; border:4px solid #3a210f; border-bottom:none; border-radius: 12px 12px 0 0; overflow:hidden; transition: all 0.1s; }
    .club .sign{ position:absolute; top:8px; left:50%; transform:translateX(-50%); padding:6px 10px; border-radius: 12px; background: var(--accent-2); color:#2b1600; font-weight:800; box-shadow: 0 2px 0 rgba(0,0,0,.2); }
    .club .shield{ position:absolute; inset:-6px; border-radius: 16px; pointer-events:none; }
    .force{ box-shadow: 0 0 0 6px rgba(0,212,255,.5), 0 0 30px 12px rgba(0,212,255,.35) inset; border-radius:16px; animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse{ 50%{ box-shadow: 0 0 0 6px rgba(0,212,255,.65), 0 0 50px 16px rgba(0,212,255,.55) inset; } }

    .entity{ position:absolute; bottom:100px; right:-100px; width:70px; height:70px; border-radius: 16px; display:grid; place-items:center; font-size:34px; font-weight:800; color:#111; outline:none; transform: scale(0.5); opacity: 0; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.2s ease-out; }
    .entity.spawned { transform: scale(1); opacity: 1; }
    .friend{ background: var(--friend); border:4px solid #228b5a; }
    .bot{ background: var(--bot); border:4px solid #70757a; }
    .phish{ background: #ffd6a5; border:4px solid #b66a00; width: 90px; height: 90px; font-size: 48px; animation: phish-wobble 2s ease-in-out infinite; }
    .spam{ width: 54px; height:38px; border-radius: 6px; background:#c5ffd6; border:4px solid #1aa36b; font-size:22px; }
    .potential_friend { background: #ffefb8; border:4px solid #d4a200; width: 54px; height: 38px; font-size:22px; border-radius:6px; }

    .panel{ background: linear-gradient(180deg, #132b69, #0c245b); border-radius: var(--radius); box-shadow: var(--shadow); padding:16px; display:grid; gap:12px; }
    .panel h2{ margin:.2rem 0 .4rem; font-size: clamp(18px,2.6vw,22px) }
    .switch{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; background:#0c1e4f; border:2px solid #1c3b8c; border-radius: 14px; }
    .switch label{ font-weight:700; letter-spacing:.3px }
    .toggle{ position:relative; width: 170px; height: 44px; border-radius: 999px; background:#203d8e; border:2px solid #3a6be0; cursor:pointer; }
    .thumb{ position:absolute; top:3px; left:3px; width: 80px; height: 34px; border-radius: 999px; background: var(--accent); transition: transform .2s ease; display:grid; place-items:center; color:#00203a; font-weight:900; }
    .toggle[data-state="right"] .thumb{ transform: translateX(82px); }

    .btn{ padding:12px 16px; border:none; border-radius: 16px; background: var(--btn); color:#00203a; font-weight:900; cursor:pointer; box-shadow: var(--shadow); font-size:16px; }
    .btn.secondary{ background: linear-gradient(180deg, #e0edff, #9ec8ff); }
    .btn.warn{ background: var(--btn-warn); color:#2d0000; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .status{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; background: #0b1b49; border:2px solid #254aa8; border-radius: var(--radius); padding:10px 12px; }
    .pill{ background:#072047; padding:8px 12px; border-radius: 999px; border:1px solid #1e57c3; font-weight:800 }
    
    .overlay{ position:fixed; inset:0; display:grid; place-items:center; background: rgba(5,10,25,.66); backdrop-filter: blur(3px); z-index:20; }
    .modal{ position: relative; max-width: 860px; background: linear-gradient(180deg, #102a6c, #0a1f51); border:3px solid #3a6be0; border-radius: 20px; padding:24px; box-shadow: var(--shadow); }
    .modal h3{ margin-top:0; font-size:28px }
    
    .btn-close {
        position: absolute; top: 10px; right: 10px; width: 36px; height: 36px;
        border: 2px solid var(--accent); background: rgba(0,0,0,0.3); color: var(--text);
        border-radius: 50%; font-size: 24px; font-weight: bold; line-height: 1;
        cursor: pointer; display: grid; place-items: center; padding: 0;
        transition: background .2s, transform .2s;
    }
    .btn-close:hover, .btn-close:focus-visible { background: var(--accent); color: var(--bg); transform: scale(1.1); }

    .graffiti { position: absolute; font-family: 'Comic Sans MS', cursive; font-size: 32px; font-weight: bold; color: var(--warn); transform: rotate(-15deg); opacity: 0.8; pointer-events: none; text-shadow: 1px 1px 2px black; }
    .club .door.open { background: #9c622e; box-shadow: inset 0 0 15px var(--accent-2); }
    .laser-beam { position: absolute; bottom: 120px; left: 140px; width: 8px; height: 100%; background: linear-gradient(90deg, transparent, #ff4d4d, #ff9aa2, #ff4d4d, transparent); box-shadow: 0 0 10px #ff4d4d, 0 0 20px #ff4d4d; transform-origin: 0 50%; border-radius: 4px; animation: fire-laser 0.4s ease-out forwards; }
    .shake-effect { animation: screen-shake 0.3s ease-in-out; }
    .score-updated { animation: score-pop 0.3s ease-out; }
    .entity.blocked { animation: entity-blocked 0.4s ease-out forwards; }
    .entity.waiting { cursor: pointer; animation: waiting-pulse 1.2s ease-in-out infinite; }
    .entity.waiting::after { content: '...'; position: absolute; top: -20px; font-size: 24px; color: white; text-shadow: 0 0 5px black; }
    
    @keyframes phish-wobble { 0%, 100% { transform: scale(1) translateY(0) rotate(-2deg); } 50% { transform: scale(1.05) translateY(-8px) rotate(2deg); } }
    @keyframes fire-laser { from { transform: scaleX(0); } to { transform: scaleX(150); } }
    @keyframes entity-blocked { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.8); opacity: 0; filter: drop-shadow(0 0 5px var(--accent)); } }
    @keyframes screen-shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-4px); } 40%, 80% { transform: translateX(4px); } }
    @keyframes score-pop { 50% { transform: scale(1.25); } }
    @keyframes waiting-pulse { 50% { transform: scale(1.1); box-shadow: 0 0 15px var(--friend); } }
  </style>
</head>
<body>
  <div class="wrap" role="application">
    <header>
      <div><h1 id="title">El Club Secreto: Guardianes de la Fortaleza</h1><p class="tagline" id="tagline">Objetivo: aplicar configuraciones básicas de privacidad en apps escolares.</p></div>
      <div class="row"><button class="btn secondary" id="btn-help">Ayuda</button><button class="btn secondary" id="btn-tutorial">Tutorial guiado</button><button class="btn" id="btn-start">Comenzar defensa</button></div>
    </header>
    <div class="status" aria-live="polite"><div class="pill" id="wave-pill">Oleada: 0/4</div><div class="pill" id="score-pill">Felicidad: 100</div><div class="pill" id="key-pill">Llaves doradas: 0</div><div class="pill" id="mode-pill">Modo: Historia</div><div class="pill" id="goal-pill" hidden></div></div>
    <div class="game"><section class="board" id="board"><div class="club"><div class="sign">CLUB SECRETO</div><div class="door"></div><div class="shield" id="shield-visual"></div></div><div class="ground"></div><div id="announce" class="sr-only" aria-live="assertive"></div></section><aside class="panel" id="control-panel"><h2>Panel de Control — Escudos de Privacidad</h2><p id="panel-desc">Usa flechas izquierda/derecha para moverte entre controles y Enter para cambiar. También puedes hacer clic.</p><div class="switch" role="group"><label id="lbl-profile">Perfil</label><div class="toggle" id="tgl-profile" tabindex="0" role="switch" aria-checked="false" data-state="left" data-left="Público" data-right="Privado"><div class="thumb">Público</div></div></div><div class="switch" role="group"><label id="lbl-msg">Quién puede enviarte mensajes</label><div class="toggle" id="tgl-msg" tabindex="0" role="switch" aria-checked="false" data-state="left" data-left="Todos" data-right="Solo amigos"><div class="thumb">Todos</div></div></div><div class="switch" role="group"><label id="lbl-friends">Quién puede ver tu lista de amigos</label><div class="toggle" id="tgl-friends" tabindex="0" role="switch" aria-checked="false" data-state="left" data-left="Todos" data-right="Solo yo"><div class="thumb">Todos</div></div></div><div class="row"><button class="btn warn" id="btn-report" disabled>Reportar y Bloquear 🚫</button><button class="btn secondary" id="btn-open-panel">Abrir panel</button></div></aside></div>
    <footer><span aria-hidden="true">🛡️</span> Ciudadanía Digital — Privacidad: público vs privado · mensajes · lista de amigos. <span aria-hidden="true">🧠</span></footer>
  </div>
  
  <div class="overlay" id="intro" role="dialog" aria-modal="true" style="display:grid;">
    <div class="modal">
      <button id="btn-intro-close" class="btn-close" aria-label="Cerrar ventana de bienvenida">&times;</button>
      <h3 id="intro-title">¡Bienvenido, Guardián!</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px">
        <div>
          <p id="intro-desc">Eres el Fundador del <strong>Club Secreto Digital</strong>. Protegerás la fortaleza de los <strong>Curi‑Bots</strong> usando los <em>escudos de privacidad</em>. ¡Pero cuidado! Algunas decisiones tienen consecuencias. <strong>Usa los botones de arriba para empezar.</strong></p>
          <ul>
            <li>Usa los escudos para bloquear Curi-Bots.</li>
            <li>¡Haz clic en los amigos que esperan en la puerta!</li>
            <li>Activa y desactiva escudos para obtener recompensas.</li>
          </ul>
        </div>
        <div aria-hidden="true"><img alt="Ilustración: club digital con escudo brillante" src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' width='360' height='220'><rect width='100%' height='100%' rx='16' fill='%23173e8c'/><rect x='22' y='70' width='160' height='120' rx='14' fill='%230d2b67' stroke='%237fb3ff' stroke-width='6'/><circle cx='102' cy='130' r='78' fill='none' stroke='%2300d4ff' stroke-width='8' opacity='.6'/><text x='24' y='48' fill='%23ffc400' font-family='Verdana' font-size='20' font-weight='bold'>CLUB SECRETO</text></svg>" style="width:100%; height:auto; border-radius:16px; box-shadow: var(--shadow);" /></div>
      </div>
    </div>
  </div>

  <div class="overlay" id="help" hidden role="dialog" aria-modal="true" style="display:none"><div class="modal"><h3 id="help-title">Ayuda rápida</h3><p id="help-desc2">Mueve el foco con flechas izquierda/derecha en el panel. Pulsa Enter o haz clic para cambiar opciones. Usa <em>Reportar y Bloquear</em> contra el <strong>Bot de Phishing</strong>. Si entran demasiados Curi‑Bots, pierdes Felicidad. Gana las 4 oleadas para obtener la <strong>Llave Dorada</strong>.</p><div class="row"><button class="btn" id="help-close">Entendido</button></div></div></div>
  <div class="overlay" id="result" hidden role="dialog" aria-modal="true" style="display:none"><div class="modal"><h3 id="result-title">Fin</h3><p id="result-desc"></p><div class="row"><button class="btn" id="btn-retry">Jugar de nuevo</button><button class="btn secondary" id="btn-infinite">Modo infinito</button></div></div></div>
  
  <!-- CORRECCIÓN (según prompt): Tutorial movido a la esquina inferior derecha (end end) -->
  <div class="overlay tutorial" id="tutorial" hidden style="display:none; place-items: end end; padding:12px; pointer-events: none; background: transparent; backdrop-filter: none;">
    <div class="modal" style="width: min(360px, 92vw); pointer-events: auto;">
      <h3 id="tut-title">Tutorial guiado</h3>
      <p id="tut-desc"></p>
      <div id="tut-body" style="min-height:120px; margin-top:6px"></div>
      <div class="progress"><div id="tut-bar" class="bar" style="width:0%"></div></div>
      <div class="steps"><button class="btn secondary" id="tut-prev" disabled>← Anterior</button><div id="tut-step-label" aria-live="polite">Paso 1/6</div><div class="row"><button class="btn secondary" id="tut-skip">Omitir</button><button class="btn" id="tut-next">Siguiente →</button></div></div>
    </div>
  </div>

  <script>
  const VOZ_ON = true;
  function speak(text){ if(!VOZ_ON || !('speechSynthesis' in window)) return; const u = new SpeechSynthesisUtterance(text); u.lang = 'es-MX'; u.rate = 1.05; u.pitch = 1.0; u.volume = 1.0; window.speechSynthesis.speak(u); }
  const audioCtx = typeof AudioContext !== 'undefined' ? new AudioContext() : null;
  function beep(type='ok', volume=0.06){ if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = type==='error' ? 'square' : 'sine'; o.frequency.value = type==='error'? 140 : 540; g.gain.value = volume; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(), 160); }

  const state = { running:false, mode:'story', waveIndex:0, score:100, keys:0, profilePrivate:false, messagesFriendsOnly:false, friendsListOnlyMe:false, bossReported:false, phishReportedCount: 0, toggles:[], focusIdx:0, spawnTimer:null, entities: [] };

  const ENTITY_SPECS = {
    friend: { emoji: '🙂', speed: 1.1 },
    bot: { emoji: '❓', speed: 1.0 },
    spam: { emoji: '✉️', speed: 1.6 },
    potential_friend: { emoji: '💌', speed: 1.4 },
    disguised_bot: { emoji: '🥸', speed: 1.3 },
    phish: { emoji: '🤖', speed: 1.0 }
  };

  const OLEADAS = [
    { id:1, nombre:'Escudo Principal', totalEntities: 10, pool: ['friend', 'friend', 'bot', 'bot', 'bot'] },
    { id:2, nombre:'Escudo de Mensajes', totalEntities: 10, pool: ['friend', 'spam', 'spam', 'potential_friend'] },
    { id:3, nombre:'Escudo de Lista de Amigos', totalEntities: 10, pool: ['friend', 'disguised_bot', 'disguised_bot'] },
    { id:4, nombre:'¡Defensa Final!', infinite: true, goal: 3, pool: ['friend', 'bot', 'spam', 'phish'] }
  ];

  const board = document.getElementById('board');
  const club = document.querySelector('.club');
  const shieldVisual = document.getElementById('shield-visual');
  const wavePill = document.getElementById('wave-pill');
  const scorePill = document.getElementById('score-pill');
  const keyPill = document.getElementById('key-pill');
  const modePill = document.getElementById('mode-pill');
  const goalPill = document.getElementById('goal-pill');
  const btnStart = document.getElementById('btn-start');
  const btnTutorial = document.getElementById('btn-tutorial');
  const btnReport = document.getElementById('btn-report');
  const tProfile = document.getElementById('tgl-profile');
  const tMsg = document.getElementById('tgl-msg');
  const tFriends = document.getElementById('tgl-friends');
  const announce = document.getElementById('announce');
  const intro = document.getElementById('intro');
  const btnIntroClose = document.getElementById('btn-intro-close');

  state.toggles = [tProfile, tMsg, tFriends, btnReport, document.getElementById('btn-open-panel')];
  
  // CORRECCIÓN (según prompt): Se añade la función faltante announceMsg
  function announceMsg(text){
    if (announce) announce.textContent = text || '';
  }

  function closeIntro() {
    intro.hidden = true;
    intro.style.display = 'none';
    if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume().catch(() => {}); }
  }

  function toggleSwitch(el){
    const cur = el.getAttribute('data-state'); const next = cur === 'left' ? 'right' : 'left';
    el.setAttribute('data-state', next);
    el.querySelector('.thumb').textContent = next === 'left' ? el.getAttribute('data-left') : el.getAttribute('data-right');
    const checked = next === 'right';
    el.setAttribute('aria-checked', String(checked));
    if(el === tProfile) { state.profilePrivate = checked; club.classList.toggle('public', !checked); }
    if(el === tMsg) state.messagesFriendsOnly = checked;
    if(el === tFriends) state.friendsListOnlyMe = checked;
    if(state.profilePrivate) shieldOn(); else shieldOff();
    beep('ok');
  }
  function shieldOn(){ shieldVisual.className = 'shield force'; }
  function shieldOff(){ shieldVisual.className = 'shield'; }

  function iniciarJuego(){
    closeIntro();
    state.running = true; state.mode='story'; state.waveIndex = 0; state.score = 100; state.phishReportedCount = 0;
    state.profilePrivate = false; state.messagesFriendsOnly = false; state.friendsListOnlyMe = false;
    [tProfile, tMsg, tFriends].forEach(t=>{ if(t.getAttribute('data-state')==='right') toggleSwitch(t); });
    club.classList.add('public'); document.querySelectorAll('.graffiti').forEach(g => g.remove());
    btnReport.disabled = true; btnReport.setAttribute('aria-pressed','false');
    updateHUD(); clearEntities();
    document.getElementById('result').hidden = true; document.getElementById('result').style.display = 'none';
    speak('¡Bienvenido Guardián! Activa tus escudos y protege el club.');
    
    mostrarOleada(0);
  }

  function mostrarOleada(id){
    if(!state.running || !OLEADAS[id]) return;
    const wave = OLEADAS[id]; state.waveIndex = id+1; updateHUD();
    
    let waveMessage = `Oleada ${state.waveIndex}: ${wave.nombre}.`;
    if (wave.infinite) {
        waveMessage = `¡Oleada Final! Sobrevive y reporta a ${wave.goal} Bots de Phishing para ganar.`;
        goalPill.hidden = false;
    }
    announceMsg(waveMessage); speak(waveMessage);
    
    btnReport.disabled = !wave.infinite;
    state.spawnTimer && clearInterval(state.spawnTimer);
    
    if (wave.infinite) {
        state.spawnTimer = setInterval(() => {
            if (!state.running) return;
            const kind = wave.pool[Math.floor(Math.random() * wave.pool.length)];
            spawnEntity(kind);
        }, 2500);
    } else {
        let spawnList = [];
        for(let i=0; i<wave.totalEntities; i++) {
            const kind = wave.pool[Math.floor(Math.random() * wave.pool.length)];
            spawnList.push(kind);
        }
        
        let idx = 0;
        state.spawnTimer = setInterval(()=>{ 
            if(idx >= spawnList.length){ 
                clearInterval(state.spawnTimer);
                setTimeout(() => nextWave(), 4000); 
                return;
            } 
            spawnEntity(spawnList[idx++]); 
        }, 1800);
    }
  }

  function spawnEntity(kind){
    const spec = ENTITY_SPECS[kind];
    const e = document.createElement('button');
    e.className = `entity ${kindToClass(kind)}`;
    e.setAttribute('aria-label', labelFor(kind));
    e.dataset.kind = kind; e.textContent = spec.emoji;
    board.appendChild(e);
    state.entities.push(e);
    requestAnimationFrame(() => { e.classList.add('spawned'); });
    const end = 70; let x = board.clientWidth - 80;
    const step = ()=>{
      if (!e.parentNode) return;
      x -= (spec.speed || 1) * 2.0;
      e.style.right = `${board.clientWidth - x - 80}px`;
      if(x <= end){ validarAccionEntity(e); return; }
      e._anim = requestAnimationFrame(step);
    };
    e._anim = requestAnimationFrame(step);
  }

  function validarAccionEntity(entity){
    if(!entity || !entity.parentNode) return;
    const kind = entity.dataset.kind;
    
    if(kind==='friend'){
      if(state.profilePrivate){
        cancelAnimationFrame(entity._anim);
        entity.classList.add('waiting');
        entity.setAttribute('aria-label', 'Amigo esperando, haz clic para dejarlo entrar');
        entity._waitTimer = setTimeout(() => friendLeavesSad(entity), 7000);
      } else {
        addScore(10, '¡Amigo entró automáticamente!');
        const door = document.querySelector('.club .door');
        door.classList.add('open');
        setTimeout(() => door.classList.remove('open'), 300);
        removeEntity(entity);
      }
      return;
    }
    
    removeEntity(entity);
    
    if(kind==='bot' || kind==='disguised_bot'){
      const isDisguised = kind === 'disguised_bot';
      const shieldWorks = isDisguised ? state.friendsListOnlyMe : state.profilePrivate;
      const errorMsg = isDisguised ? '¡Bot disfrazado entró! Oculta tu lista de amigos.' : '¡Curi‑Bot entró! Activa perfil privado.';

      if(shieldWorks){ feedback('ok','Amenaza bloqueada.'); blockEntity(entity); }
      else { damage(errorMsg); }
    }
    if(kind==='spam'){
      if(state.messagesFriendsOnly){ feedback('ok','Spam bloqueado.'); blockEntity(entity); }
      else { damage('¡Spam recibido! Cambia a Solo amigos.'); }
    }
    if(kind==='potential_friend'){
      if(state.messagesFriendsOnly){ feedback('error','¡Invitación perdida!'); blockEntity(entity); }
      else { addScore(25, '¡Invitación recibida! +25 Felicidad.'); }
    }
    if(kind==='phish'){
       damage('¡Bot de Phishing atacando! ¡Repórtalo rápido!');
    }
  }
  
  function friendLeavesSad(entity){
    if(!entity || !entity.parentNode) return;
    entity.textContent = '🙁';
    entity.classList.remove('waiting');
    damage('Un amigo se fue triste.', 5);
    setTimeout(() => removeEntity(entity), 500);
  }
  
  board.addEventListener('click', (event) => {
    const target = event.target.closest('.entity.waiting');
    if(target && target.dataset.kind === 'friend'){
      clearTimeout(target._waitTimer);
      addScore(15, '¡Amigo bienvenido!');
      const door = document.querySelector('.club .door');
      door.classList.add('open');
      setTimeout(() => door.classList.remove('open'), 300);
      removeEntity(target);
    }
  });

  function handlePhishReport() {
    if (!state.running || OLEADAS[state.waveIndex - 1]?.id !== 4) return;
    
    const phishBot = state.entities.find(e => e.dataset.kind === 'phish');
    if (phishBot) {
        state.phishReportedCount++;
        updateHUD();
        feedback('boss','¡Bot de Phishing reportado!');
        
        const laserBeam = document.createElement('div');
        laserBeam.className = 'laser-beam'; board.appendChild(laserBeam);
        blockEntity(phishBot);
        setTimeout(() => laserBeam.remove(), 500);

        if (state.phishReportedCount >= OLEADAS[3].goal) {
            setTimeout(() => finalizarJuego('victoria'), 1000);
        }
    } else {
        feedback('error', 'No hay ningún Bot de Phishing que reportar ahora.');
        damage('¡Reporte en falso!', 2);
    }
  }
  
  function addScore(n, msg=''){ state.score = Math.max(0, Math.min(150, state.score + n)); updateHUD(); if(msg) feedback('ok', msg); scorePill.classList.add('score-updated'); setTimeout(() => scorePill.classList.remove('score-updated'), 300); }
  function damage(msg, amount = 10){ addScore(-amount); feedback('error', msg); const graffiti = document.createElement('div'); graffiti.className = 'graffiti'; graffiti.textContent = '❓'; graffiti.style.top = `${Math.random()*60+10}%`; graffiti.style.left = `${Math.random()*60+20}%`; club.appendChild(graffiti); board.classList.add('shake-effect'); setTimeout(() => board.classList.remove('shake-effect'), 300); if(state.score<=0 && state.running) finalizarJuego('derrota'); }
  
  function nextWave(){ if(state.waveIndex >= OLEADAS.length -1){ mostrarOleada(3); } else { mostrarOleada(state.waveIndex); } }
  function removeEntity(entity) { if(!entity) return; cancelAnimationFrame(entity._anim); clearTimeout(entity._waitTimer); entity.remove(); state.entities = state.entities.filter(e => e !== entity); }
  function blockEntity(entity){ if (!entity) return; entity.classList.add('blocked'); setTimeout(() => removeEntity(entity), 400); }
  function clearEntities(){ [...state.entities].forEach(removeEntity); }
  
  function updateHUD(){ 
    wavePill.textContent = `Oleada: ${Math.min(state.waveIndex,4)}/4`; 
    scorePill.textContent = `Felicidad: ${state.score}`; 
    keyPill.textContent = `Llaves doradas: ${state.keys}`; 
    modePill.textContent = `Modo: ${state.mode==='story' ? 'Historia' : 'Infinito'}`;
    if (OLEADAS[state.waveIndex-1]?.infinite) {
        goalPill.textContent = `Reportados: ${state.phishReportedCount}/${OLEADAS[3].goal}`;
    } else {
        goalPill.hidden = true;
    }
  }

  function kindToClass(kind) { return {friend:'friend', bot:'bot', phish:'phish', spam:'spam', potential_friend: 'potential_friend', disguised_bot: 'bot'}[kind] || ''; }
  function labelFor(kind){ return {friend:'Amigo', bot:'Curi‑Bot', phish:'Bot de Phishing', spam:'Mensaje spam', potential_friend:'Invitación', disguised_bot: 'Bot Disfrazado'}[kind] || 'Entidad'; }
  function feedback(tipo, msg){ if(tipo==='ok'){ speak(msg); beep('ok'); } else if(tipo==='error'){ speak(msg); beep('error'); } else if(tipo==='boss'){ speak(msg); } announce.textContent = msg; }

  function finalizarJuego(resultado){
    state.running = false; 
    clearEntities(); 
    clearInterval(state.spawnTimer);
    let title='', desc='';
    if(resultado==='victoria'){ state.keys += 1; updateHUD(); title = '¡Victoria! Fiesta segura 🎉'; desc = '¡Misión cumplida! Derrotaste a los bots de phishing y tu club es una fortaleza. Frase de poder: “Con mi perfil privado y bien configurado, mi espacio digital está siempre cuidado”.'; } 
    else { title = 'Fiesta cancelada 😿'; desc = 'Demasiados Curi‑Bots o amigos tristes. El Mentor te anima a intentarlo otra vez para proteger el club.'; }
    const resultDialog = document.getElementById('result');
    resultDialog.querySelector('#result-title').textContent = title; resultDialog.querySelector('#result-desc').textContent = desc;
    resultDialog.hidden = false; resultDialog.style.display = 'grid'; resultDialog.querySelector('#btn-retry').focus();
  }

  const STEPS = [ { id:1, t:'Bienvenida', d:'Defenderás el Club Secreto de los Curi-Bots ❓ y dejarás pasar a tus amigos 🙂.' }, { id:2, t:'Panel de control', d:'Aquí ajustas tus escudos con clic o teclado (⇦⇨ y Enter).' }, { id:3, t:'Dilema: Perfil Privado', d:'En "Privado", los bots son bloqueados. ¡Pero tus amigos esperarán! **Hazles clic** para dejarlos entrar.'}, { id:4, t:'Dilema: Mensajes', d:'"Solo amigos" bloquea el spam ✉️. Pero a veces recibirás una invitación 💌. Cambia a "Todos" para aceptarla.'}, { id:5, t:'Escudo: Lista de Amigos', d:'"Solo yo" oculta tu lista de amigos a los bots disfrazados 🥸. ¡Este escudo no tiene desventajas!' }, { id:6, t:'Jefe: Reportar', d:'Si ves un bot de phishing 🤖, ¡usa el botón "Reportar y Bloquear" para expulsarlo!' }, ];
  let stepIndex = 0;
  function startTutorial(){ closeIntro(); clearEntities(); [tProfile, tMsg, tFriends].forEach(t=>{ if(t.getAttribute('data-state')==='right') toggleSwitch(t); }); shieldOff(); btnReport.disabled = true; document.getElementById('tutorial').hidden=false; document.getElementById('tutorial').style.display='grid'; speak('Comencemos el tutorial guiado.'); showStep(0); }
  function showStep(i){ stepIndex = i; const s = STEPS[i]; clearEntities(); document.querySelectorAll('.hi').forEach(n=>n.classList.remove('hi')); document.getElementById('tut-prev').disabled = i===0; document.getElementById('tut-next').textContent = (i===STEPS.length-1)? 'Terminar' : 'Siguiente →'; document.getElementById('tut-step-label').textContent = `Paso ${i+1}/${STEPS.length}`; document.getElementById('tut-bar').style.width = `${((i)/(STEPS.length-1))*100}%`; document.getElementById('tut-body').innerHTML = `<strong>${s.t}</strong><br>${s.d}`; const el = document.getElementById({3: 'tgl-profile', 4: 'tgl-msg', 5: 'tgl-friends', 6: 'btn-report'}[s.id]); if(el) { el.classList.add('hi'); el.scrollIntoView({behavior:'smooth', block:'center'}); } if (s.id === 3) { toggleIfNeeded(tProfile, true); const friend = spawnDemo('friend'); setTimeout(() => { if(friend && friend.parentNode) { friend.classList.add('waiting'); friend.dataset.state = 'waiting'; } }, 2500); setTimeout(() => { if(friend && friend.parentNode) removeEntity(friend); }, 5000); } if (s.id === 4) { toggleIfNeeded(tMsg, true); const invite = spawnDemo('potential_friend'); setTimeout(() => { if(invite && invite.parentNode) blockEntity(invite); }, 2500); setTimeout(() => { toggleIfNeeded(tMsg, false); spawnDemo('potential_friend'); }, 3500); } if (s.id === 6) { btnReport.disabled = false; } speak(`${s.t}. ${s.d}`); }
  function spawnDemo(kind){ const spec = ENTITY_SPECS[kind]; const e = document.createElement('button'); e.className = `entity ${kindToClass(kind)}`; e.setAttribute('aria-label', labelFor(kind)); e.dataset.kind = kind; e.textContent = spec.emoji; board.appendChild(e); state.entities.push(e); requestAnimationFrame(() => { e.classList.add('spawned'); }); return e; }
  function toggleIfNeeded(toggleEl, makeRight){ const isRight = toggleEl.getAttribute('data-state')==='right'; if(!!isRight !== !!makeRight){ toggleSwitch(toggleEl); } }
  
  btnStart.addEventListener('click', iniciarJuego);
  btnTutorial.addEventListener('click', startTutorial);
  btnIntroClose.addEventListener('click', closeIntro);
  [tProfile, tMsg, tFriends].forEach(t=>{ t.addEventListener('click', ()=> toggleSwitch(t)); t.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); toggleSwitch(t); } }); });
  btnReport.addEventListener('click', handlePhishReport);
  document.getElementById('btn-retry').addEventListener('click', iniciarJuego);
  document.getElementById('tut-prev').addEventListener('click', ()=>{ if(stepIndex>0) showStep(stepIndex-1); });
  
  // CORRECCIÓN (según prompt): Asegurar que el tutorial se oculte correctamente
  document.getElementById('tut-next').addEventListener('click', () => {
    if (stepIndex < STEPS.length - 1) {
      showStep(stepIndex + 1);
    } else {
      const t = document.getElementById('tutorial');
      t.hidden = true;
      t.style.display = 'none';
    }
  });

  document.getElementById('tut-skip').addEventListener('click', () => {
    const t = document.getElementById('tutorial');
    t.hidden = true;
    t.style.display = 'none';
  });
  
  </script>
</body>
</html>
